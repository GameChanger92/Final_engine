name: CI

on:
  push:
    branches: ["*"]          # ëª¨ë“  ë¸Œëœì¹˜ì—ì„œ í‘¸ì‹œ ì‹œ ë™ì‘
  pull_request:
    branches: ["*"]          # ëª¨ë“  ë¸Œëœì¹˜ PRì—ì„œ ë™ì‘

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job_type: [unit, bench]
    
    env:                     # ğŸ‘ˆ ë§¤íŠ¸ë¦­ìŠ¤ë³„ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      UNIT_TEST_MODE: ${{ matrix.job_type == 'unit' && '1' || '0' }}
      FAST_MODE: ${{ matrix.job_type == 'bench' && '1' || '0' }}

    steps:
      # 1) ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      # 2) íŒŒì´ì¬ ì„¤ì¹˜
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3) ì˜ì¡´ì„± + í¬ë§¤í„°/ë¦°í„° ì„¤ì¹˜
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install black ruff pytest

      # 4) í’ˆì§ˆ ê²€ì‚¬ (unit í…ŒìŠ¤íŠ¸ì—ì„œë§Œ ì‹¤í–‰)
      - name: Ruff Lint
        if: matrix.job_type == 'unit'
        run: ruff check .

      - name: Black Check
        if: matrix.job_type == 'unit'
        run: black --check .

      # 5) ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (unitì—ì„œëŠ” UNIT_TEST_MODE=1, FAST_MODE=0)
      - name: Run pytest (Unit Tests)
        if: matrix.job_type == 'unit'
        run: pytest -q

      # 6) ë²¤ì¹˜ë§ˆí¬/í†µí•© í…ŒìŠ¤íŠ¸ (benchì—ì„œëŠ” UNIT_TEST_MODE=0, FAST_MODE=1)
      - name: Test pipeline script (Benchmark)
        if: matrix.job_type == 'bench'
        run: python scripts/run_pipeline.py --project-id default --episodes 2
